#include "Arduino_LED_Matrix.h"

ArduinoLEDMatrix matrix;

byte frame[8][12] = {0};

// Animación de órbita rotativa en 4 esquinas
byte orbit[4][8][12] = {
  { // Marco 0: Esquina superior izquierda
    {1,1,0,0,0,0,0,0,0,0,1,1},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {1,1,0,0,0,0,0,0,0,0,1,1}
  },
  { // Marco 1: Esquina superior derecha
    {1,1,0,0,0,0,0,0,0,0,1,1},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {1,1,0,0,0,0,0,0,0,0,1,1}
  },
  { // Marco 2: Esquina inferior derecha
    {1,1,0,0,0,0,0,0,0,0,1,1},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {1,1,0,0,0,0,0,0,0,0,1,1}
  },
  { // Marco 3: Esquina inferior izquierda
    {1,1,0,0,0,0,0,0,0,0,1,1},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {1,1,0,0,0,0,0,0,0,0,1,1}
  }
};

// Onda perimetral en expansión
byte wave[6][8][12] = {
  { // Onda 1
    {1,1,1,1,1,1,1,1,1,1,1,1},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,0,0,1},
    {1,1,1,1,1,1,1,1,1,1,1,1}
  },
  { // Onda 2
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,1,1,1,1,1,1,1,1,1,1,0},
    {0,1,0,0,0,0,0,0,0,0,1,0},
    {0,1,0,0,0,0,0,0,0,0,1,0},
    {0,1,0,0,0,0,0,0,0,0,1,0},
    {0,1,0,0,0,0,0,0,0,0,1,0},
    {0,1,1,1,1,1,1,1,1,1,1,0},
    {0,0,0,0,0,0,0,0,0,0,0,0}
  },
  { // Onda 3
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,1,1,1,1,1,1,1,1,0,0},
    {0,0,1,0,0,0,0,0,0,1,0,0},
    {0,0,1,0,0,0,0,0,0,1,0,0},
    {0,0,1,1,1,1,1,1,1,1,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0}
  },
  { // Onda 4
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,1,1,1,1,1,1,0,0,0},
    {0,0,0,1,1,1,1,1,1,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0}
  },
  { // Onda 5 (inversa)
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,1,1,0,0,0,0,0},
    {0,0,0,0,0,1,1,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0}
  },
  { // Onda 6 (punto central mínimo)
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0}
  }
};

byte dispatch[12][8][12] = {  // 12 frames para cubrir todas las letras y transiciones
   { // Frame 0: D
     {0,0,0,1,1,1,1,1,1,0,0,0},
     {0,0,1,1,0,0,0,0,1,1,0,0},
     {0,1,1,0,0,0,0,0,0,1,1,0},
     {0,1,0,0,0,0,0,0,0,0,1,0},
     {0,1,0,0,0,0,0,0,0,0,1,0},
     {0,1,1,0,0,0,0,0,0,1,1,0},
     {0,0,1,1,1,1,1,1,1,1,0,0},
     {0,0,0,0,0,0,0,0,0,0,0,0}
   },
   { // Frame 1: DI (transición)
     {0,0,0,1,1,1,1,1,0,0,0,0},
     {0,0,1,1,0,0,0,1,1,0,0,0},
     {0,1,1,0,0,0,0,0,1,1,0,0},
     {0,1,0,0,0,0,0,0,0,1,0,0},
     {0,1,0,0,0,0,0,0,0,1,0,0},
     {0,1,1,0,0,0,0,0,1,1,0,0},
     {0,0,1,1,1,1,1,1,1,0,0,0},
     {0,0,0,0,1,1,0,0,0,0,0,0}
   },
   { // Frame 2: I
     {0,0,0,0,1,1,1,1,0,0,0,0},
     {0,0,0,0,0,1,1,0,0,0,0,0},
     {0,0,0,0,0,1,1,0,0,0,0,0},
     {0,0,0,0,0,1,1,0,0,0,0,0},
     {0,0,0,0,0,1,1,0,0,0,0,0},
     {0,0,0,0,0,1,1,0,0,0,0,0},
     {0,0,0,0,1,1,1,1,0,0,0,0},
     {0,0,0,0,0,0,0,0,0,0,0,0}
   },
   { // Frame 3: S
     {0,0,0,1,1,1,1,1,0,0,0,0},
     {0,0,1,1,0,0,0,1,1,0,0,0},
     {0,1,1,0,0,0,0,0,1,0,0,0},
     {0,0,1,1,1,1,1,1,0,0,0,0},
     {0,0,0,0,1,1,1,1,1,0,0,0},
     {0,1,0,0,0,0,0,0,1,1,0,0},
     {0,1,1,1,1,1,1,1,1,0,0,0},
     {0,0,0,0,0,0,0,0,0,0,0,0}
   },
   { // Frame 4: P
     {0,0,1,1,1,1,1,1,0,0,0,0},
     {0,1,1,0,0,0,0,1,1,0,0,0},
     {0,1,0,0,0,0,0,0,1,0,0,0},
     {0,1,1,1,1,1,1,1,0,0,0,0},
     {0,1,0,0,0,0,0,0,0,0,0,0},
     {0,1,0,0,0,0,0,0,0,0,0,0},
     {0,1,1,1,1,1,1,1,1,0,0,0},
     {0,0,0,0,0,0,0,0,0,0,0,0}
   },
   { // Frame 5: A
     {0,0,0,1,1,1,1,0,0,0,0,0},
     {0,0,1,1,0,0,1,1,0,0,0,0},
     {0,1,1,0,0,0,0,1,1,0,0,0},
     {0,1,1,1,1,1,1,1,1,0,0,0},
     {0,1,1,0,0,0,0,1,1,0,0,0},
     {0,1,1,0,0,0,0,1,1,0,0,0},
     {0,1,1,0,0,0,0,1,1,0,0,0},
     {0,0,0,0,0,0,0,0,0,0,0,0}
   },
   { // Frame 6: T
     {0,1,1,1,1,1,1,1,1,1,0,0},
     {0,0,0,0,1,1,0,0,0,0,0,0},
     {0,0,0,0,1,1,0,0,0,0,0,0},
     {0,0,0,0,1,1,0,0,0,0,0,0},
     {0,0,0,0,1,1,0,0,0,0,0,0},
     {0,0,0,0,1,1,0,0,0,0,0,0},
     {0,0,0,1,1,1,1,0,0,0,0,0},
     {0,0,0,0,0,0,0,0,0,0,0,0}
   },
   { // Frame 7: C
     {0,0,0,1,1,1,1,1,0,0,0,0},
     {0,0,1,1,0,0,0,1,1,0,0,0},
     {0,1,1,0,0,0,0,0,1,0,0,0},
     {0,1,0,0,0,0,0,0,0,0,0,0},
     {0,1,0,0,0,0,0,0,0,0,0,0},
     {0,1,1,0,0,0,0,0,1,0,0,0},
     {0,0,1,1,1,1,1,1,0,0,0,0},
     {0,0,0,0,0,0,0,0,0,0,0,0}
   },
   { // Frame 8: H
     {0,1,1,0,0,0,0,0,1,1,0,0},
     {0,1,1,0,0,0,0,0,1,1,0,0},
     {0,1,1,0,0,0,0,0,1,1,0,0},
     {0,1,1,1,1,1,1,1,1,1,0,0},
     {0,1,1,0,0,0,0,0,1,1,0,0},
     {0,1,1,0,0,0,0,0,1,1,0,0},
     {0,1,1,0,0,0,0,0,1,1,0,0},
     {0,0,0,0,0,0,0,0,0,0,0,0}
   },
   { // Frame 9: I (segunda vez)
     {0,0,0,0,1,1,1,1,0,0,0,0},
     {0,0,0,0,0,1,1,0,0,0,0,0},
     {0,0,0,0,0,1,1,0,0,0,0,0},
     {0,0,0,0,0,1,1,0,0,0,0,0},
     {0,0,0,0,0,1,1,0,0,0,0,0},
     {0,0,0,0,0,1,1,0,0,0,0,0},
     {0,0,0,0,1,1,1,1,0,0,0,0},
     {0,0,0,0,0,0,0,0,0,0,0,0}
   },
   { // Frame 10: N
     {0,1,1,0,0,0,0,0,1,1,0,0},
     {0,1,1,1,0,0,0,0,1,1,0,0},
     {0,1,1,1,1,0,0,0,1,1,0,0},
     {0,1,1,0,1,1,0,0,1,1,0,0},
     {0,1,1,0,0,1,1,0,1,1,0,0},
     {0,1,1,0,0,0,1,1,1,1,0,0},
     {0,1,1,0,0,0,0,1,1,1,0,0},
     {0,0,0,0,0,0,0,0,0,0,0,0}
   },
   { // Frame 11: G
     {0,0,0,1,1,1,1,1,0,0,0,0},
     {0,0,1,1,0,0,0,1,1,0,0,0},
     {0,1,1,0,0,0,0,0,1,0,0,0},
     {0,1,0,0,0,1,1,1,1,0,0,0},
     {0,1,0,0,0,0,0,0,1,0,0,0},
     {0,1,1,0,0,0,0,1,1,0,0,0},
     {0,0,1,1,1,1,1,1,0,0,0,0},
     {0,0,0,0,0,0,0,0,0,0,0,0}
   }
 };

// Configuración de sensores
#define TURBIDITY_PIN A0
#define PH_PIN        A2
#define CONDUCT_PIN   A4

// Parámetros de calibración (mantén igual)
float turbidez_cal_slope = -1.408;
float turbidez_cal_offset = 1000.0;
float ph_cal_slope = 0.022;
float ph_cal_offset = 70.0;
float conductividad_cal_slope = 3.0;
float conductividad_cal_offset = 0.0;

// Variables para timing
unsigned long lastSensorUpdate = 0;
unsigned long lastFrameChange = 0;
const long sensorInterval = 5000;  // 5 segundos
const int frameDuration = 100;     // Velocidad animación loader
int currentWaveFrame = 0;
bool sendingData = false;

void setup() {
   matrix.begin();
   Serial.begin(9600);
   pinMode(TURBIDITY_PIN, INPUT);
   pinMode(PH_PIN, INPUT);
   pinMode(CONDUCT_PIN, INPUT);
}

void loop() {
   unsigned long currentMillis = millis();
   
   if (!sendingData) {
     if (currentMillis - lastFrameChange >= frameDuration) {
       updateLoader();
       lastFrameChange = currentMillis;
     }
   }
 
   if (currentMillis - lastSensorUpdate >= sensorInterval) {
     sendingData = true;
     showDispatchMessage();
     readAndSendSensorData();
     sendingData = false;
     lastSensorUpdate = currentMillis;
   }
 }

void updateLoader() {
   memcpy(frame, wave[currentWaveFrame], sizeof(frame));
   matrix.renderBitmap(frame, 8, 12);
   currentWaveFrame = (currentWaveFrame + 1) % 6;
 }

void showDispatchMessage() {
   for(int i = 0; i < 12; i++) {
     memcpy(frame, dispatch[i], sizeof(frame));
     matrix.renderBitmap(frame, 8, 12);
     delay(150);
     
     if(i % 2 == 0 && i != 0) {
       clearFrame();
       matrix.renderBitmap(frame, 8, 12);
       delay(50);
     }
   }
   clearFrame();
 }

void readAndSendSensorData() {
   int turbidez_raw = analogRead(TURBIDITY_PIN);
   int ph_raw = analogRead(PH_PIN);
   int conductividad_raw = analogRead(CONDUCT_PIN);
   
   float turbidez_voltaje = (turbidez_raw * 5.0) / 1023.0;
   float turbidez_ntu = turbidez_voltaje - 1120.4 * pow(turbidez_voltaje, 2) + 5742.3 * turbidez_voltaje - 4352.9;
   float ph_value = ph_raw * ph_cal_slope + ph_cal_offset;
   float conductividad_us = conductividad_raw * conductividad_cal_slope + conductividad_cal_offset;
 
   turbidez_ntu = constrain(turbidez_ntu, 0, 1000);
   ph_value = constrain(ph_value, 0, 14);
   conductividad_us = constrain(conductividad_us, 0, 1500);
 
   Serial.print("T:");
   Serial.print(turbidez_ntu, 2);
   Serial.print(";PH:");
   Serial.print(ph_value, 2);
   Serial.print(";C:");
   Serial.println(conductividad_us, 2);
 }

void clearFrame() {
   memset(frame, 0, sizeof(frame[0][0]) * 8 * 12);
 }